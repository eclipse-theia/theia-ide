# Builder stage
FROM node:18-bullseye as build-stage

# install required tools to build the application
RUN apt-get update && apt-get install -y libxkbfile-dev libsecret-1-dev

WORKDIR /home/theia

# Copy required configuration files
COPY yarn.lock yarn.lock
COPY package.json package.json
COPY tsconfig.json tsconfig.json
COPY lerna.json lerna.json
COPY configs configs

# Copy Browser Application (do not copy electron application)
COPY applications applications

# Copy Theia Extensions (launcher, product, updater)
COPY theia-extensions theia-extensions

# Copy repository files
#COPY . .

# Copy image specific files - this should overwrite the default files from the repository
COPY images/base-ide/ .

# Remove unnecesarry files for the browser application
# Download plugins and build application production mode
# Use yarn autoclean to remove unnecessary files from package dependencies
RUN yarn --pure-lockfile
RUN yarn build:extensions
RUN yarn download:plugins
RUN yarn browser build
RUN yarn
RUN yarn autoclean --init
RUN echo *.ts >> .yarnclean
RUN echo *.ts.map >> .yarnclean
RUN echo *.spec.* >> .yarnclean
RUN yarn autoclean --force
RUN yarn cache clean
RUN rm -r applications/electron theia-extensions/launcher theia-extensions/updater node_modules

# Base-IDE Stage generating a image for others to copy from. ItÂ´s also startable for debug reasons.
FROM node:18-bullseye-slim as base-ide

COPY --from=build-stage /home/theia /home/theia

WORKDIR /home/theia
ENV HOME /home/theia

# Specify default shell for Theia and the Built-In plugins directory
ENV SHELL=/bin/bash \
    THEIA_DEFAULT_PLUGINS=local-dir:/home/theia/plugins

EXPOSE 3000

# Launch the backend application via node
ENTRYPOINT [ "node", "/home/theia/applications/browser/lib/backend/main.js" ]

# Arguments passed to the application
CMD [ "/home/project", "--hostname=0.0.0.0" ]